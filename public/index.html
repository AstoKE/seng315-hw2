<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Live Chat App</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      :root {
        --bg: #020617;
        --bg-alt: #020617;
        --card: #020617;
        --card-soft: #020617;
        --accent: #3b82f6;
        --accent-soft: rgba(59, 130, 246, 0.15);
        --accent-strong: rgba(59, 130, 246, 0.8);
        --text: #e5e7eb;
        --muted: #9ca3af;
        --border: #020617;
        --danger: #ef4444;
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        min-height: 100vh;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        background: radial-gradient(circle at top left, #0f172a, #020617 55%);
        color: var(--text);
        display: flex;
        align-items: stretch;
        justify-content: center;
      }
      .app-shell {
        width: 100%;
        max-width: 1120px;
        margin: 1.5rem;
        border-radius: 1.5rem;
        background: linear-gradient(145deg, #020617 0%, #020617 55%, #111827);
        border: 1px solid rgba(148, 163, 184, 0.25);
        box-shadow: 0 22px 60px rgba(15, 23, 42, 0.85);
        display: flex;
        overflow: hidden;
      }

      /* LEFT PANE */
      .sidebar {
        width: 280px;
        background: radial-gradient(circle at top left, #111827, #020617 60%);
        border-right: 1px solid rgba(148, 163, 184, 0.2);
        padding: 1.5rem 1.25rem;
        display: flex;
        flex-direction: column;
        gap: 1.25rem;
      }
      .logo {
        display: flex;
        align-items: center;
        gap: 0.6rem;
      }
      .logo-badge {
        width: 32px;
        height: 32px;
        border-radius: 999px;
        background: radial-gradient(circle at 30% 30%, #60a5fa, #1d4ed8);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 0.9rem;
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.25);
      }
      .logo-text-title {
        font-weight: 600;
        letter-spacing: 0.02em;
        font-size: 0.95rem;
      }
      .logo-text-sub {
        font-size: 0.78rem;
        color: var(--muted);
      }
      .current-user {
        padding: 0.75rem 0.9rem;
        border-radius: 0.9rem;
        background: linear-gradient(
          135deg,
          rgba(15, 118, 110, 0.16),
          rgba(59, 130, 246, 0.1)
        );
        border: 1px solid rgba(45, 212, 191, 0.3);
        display: flex;
        align-items: center;
        gap: 0.75rem;
        font-size: 0.85rem;
      }
      .avatar {
        width: 30px;
        height: 30px;
        border-radius: 999px;
        background: radial-gradient(circle at 30% 30%, #22c55e, #15803d);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.9rem;
        font-weight: 600;
        color: white;
      }
      .user-meta span {
        display: block;
      }
      .user-label {
        font-size: 0.75rem;
        color: var(--muted);
      }
      .user-name {
        font-size: 0.9rem;
        font-weight: 500;
      }
      .status-pill {
        font-size: 0.7rem;
        padding: 0.15rem 0.5rem;
        border-radius: 999px;
        border: 1px solid rgba(34, 197, 94, 0.5);
        color: #bbf7d0;
        background: rgba(22, 163, 74, 0.15);
      }
      .section-title {
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: var(--muted);
        margin-bottom: 0.35rem;
      }
      .rooms {
        display: flex;
        flex-direction: column;
        gap: 0.4rem;
      }
      .room-pill {
        border-radius: 999px;
        padding: 0.5rem 0.7rem;
        border: 1px solid rgba(148, 163, 184, 0.4);
        font-size: 0.78rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
        cursor: default;
      }
      .room-pill.active {
        background: var(--accent-soft);
        border-color: var(--accent);
      }
      .room-pill span:last-child {
        font-size: 0.7rem;
        color: var(--muted);
      }
      .info-box {
        margin-top: auto;
        font-size: 0.75rem;
        color: var(--muted);
        border-radius: 0.9rem;
        border: 1px dashed rgba(148, 163, 184, 0.45);
        padding: 0.7rem 0.75rem;
        background: radial-gradient(circle at top left, #0b1120, #020617);
      }

      /* RIGHT PANE */
      .main {
        flex: 1;
        display: flex;
        flex-direction: column;
        height: calc(100vh - 3rem);
        padding: 1.25rem 1.5rem;
        gap: 0.85rem;
      }
      .top-bar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 0.75rem;
      }
      .top-info h1 {
        margin: 0;
        font-size: 1rem;
        letter-spacing: 0.02em;
      }
      .top-info span {
        display: block;
        font-size: 0.8rem;
        color: var(--muted);
      }
      .badge {
        font-size: 0.7rem;
        padding: 0.25rem 0.55rem;
        border-radius: 999px;
        border: 1px solid rgba(59, 130, 246, 0.6);
        color: #bfdbfe;
        background: rgba(15, 23, 42, 0.9);
      }
      .join-card {
        border-radius: 1rem;
        border: 1px solid var(--border);
        background: radial-gradient(circle at top left, #0b1120, #020617 65%);
        padding: 1.5rem 1.25rem;
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
        margin-bottom: 0.25rem;
      }
      .join-title {
        font-size: 0.95rem;
        font-weight: 500;
      }
      .join-sub {
        font-size: 0.8rem;
        color: var(--muted);
      }
      .join-form {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
        margin-top: 0.5rem;
      }
      .input {
        padding: 0.5rem 0.75rem;
        border-radius: 999px;
        border: 1px solid rgba(148, 163, 184, 0.6);
        background: rgba(15, 23, 42, 0.9);
        color: var(--text);
        font-size: 0.85rem;
        min-width: 180px;
        flex: 1;
      }
      .btn {
        border: none;
        border-radius: 999px;
        padding: 0.5rem 1rem;
        font-size: 0.85rem;
        font-weight: 500;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.3rem;
      }
      .btn-primary {
        background: linear-gradient(135deg, #2563eb, #1d4ed8);
        color: #eff6ff;
        box-shadow: 0 10px 25px rgba(37, 99, 235, 0.6);
      }
      .btn-primary:disabled {
        opacity: 0.7;
        cursor: default;
        box-shadow: none;
      }
      .btn-ghost {
        background: transparent;
        color: var(--muted);
        border: 1px solid rgba(148, 163, 184, 0.6);
      }
      .error-text {
        font-size: 0.78rem;
        color: var(--danger);
      }

      .chat-shell {
        flex: 1;
        display: flex;
        flex-direction: column;
        border-radius: 1rem;
        border: 1px solid rgba(148, 163, 184, 0.3);
        background: radial-gradient(circle at top left, #020617, #020617 70%);
        overflow: hidden;
        min-height: 0;
      }
      .messages {
        flex: 1;
        padding: 0.9rem 0.9rem 0.75rem;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        justify-content: flex-end;
        gap: 0.45rem;
        scrollbar-width: auto;
        height: 100%;
        min-height: 0;
      }
      .msg-row {
        display: flex;
        align-items: flex-end;
        gap: 0.4rem;
        max-width: 80%;
      }
      .msg-row.self {
        margin-left: auto;
        flex-direction: row-reverse;
      }
      .msg-bubble {
        padding: 0.45rem 0.65rem 0.4rem;
        border-radius: 0.9rem;
        font-size: 0.8rem;
        line-height: 1.2;
        border: 1px solid rgba(148, 163, 184, 0.45);
        background: rgba(15, 23, 42, 0.95);
      }
      .msg-row.self .msg-bubble {
        background: linear-gradient(135deg, #2563eb, #1d4ed8);
        border-color: transparent;
        color: white;
      }
      .msg-meta {
        font-size: 0.7rem;
        color: var(--muted);
        margin-bottom: 0.16rem;
      }
      .msg-author {
        font-weight: 500;
      }
      .msg-time {
        font-size: 0.7rem;
        color: var(--muted);
        margin-top: 0.12rem;
      }
      .msg-avatar {
        width: 24px;
        height: 24px;
        border-radius: 999px;
        background: rgba(51, 65, 85, 0.85);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.7rem;
        color: #e5e7eb;
      }
      .msg-row.self .msg-avatar {
        background: rgba(59, 130, 246, 0.9);
      }

      .composer {
        display: flex;
        align-items: center;
        gap: 0.6rem;
        padding: 0.55rem 0.75rem;
        border-top: 1px solid rgba(148, 163, 184, 0.3);
        background: rgba(15, 23, 42, 0.95);
      }
      .composer-input {
        flex: 1;
        padding: 0.55rem 0.8rem;
        border-radius: 999px;
        border: 1px solid rgba(148, 163, 184, 0.5);
        background: rgba(15, 23, 42, 0.98);
        color: var(--text);
        font-size: 0.85rem;
      }
      .composer-input::placeholder {
        color: #6b7280;
      }
      .composer-status {
        font-size: 0.7rem;
        color: var(--muted);
        margin-left: 0.25rem;
      }
      .logout-btn {
        margin-left: auto;
        font-size: 0.7rem;
        padding: 0.25rem 0.7rem;
        border-radius: 999px;
        border: 1px solid rgba(148, 163, 184, 0.6);
        background: transparent;
        color: var(--muted);
        cursor: pointer;
        transition: all 0.15s ease;
      }

      .logout-btn:hover {
        border-color: var(--accent);
        color: #bfdbfe;
        background: rgba(15, 23, 42, 0.9);
      }


      @media (max-width: 840px) {
        .app-shell {
          flex-direction: column;
          max-width: 100%;
          margin: 0;
          border-radius: 0;
        }
        .sidebar {
          width: 100%;
          border-right: none;
          border-bottom: 1px solid rgba(148, 163, 184, 0.2);
        }
      }
    </style>
  </head>
  <body>
    <div class="app-shell">
      <!-- LEFT SIDEBAR -->
      <aside class="sidebar">
        <div class="logo">
          <div class="logo-badge">LC</div>
          <div>
            <div class="logo-text-title">Live Chat</div>
            <div class="logo-text-sub">SENG315 Â· Group 11</div>
          </div>
        </div>

        <div id="currentUserCard" class="current-user" style="display:none;">
          <div class="avatar" id="userAvatar">?</div>
          <div class="user-meta">
            <span class="user-label">Signed in as</span>
            <span class="user-name" id="currentUserName">-</span>
          </div>
          <span class="status-pill">online</span>

          <button id="logoutBtn" class="logout-btn" type="button">
            Log out
          </button>
        </div>

        <div>
          <div class="section-title">Room</div>
          <div class="rooms">
            <div class="room-pill active">
              <span># general</span>
              <span>public</span>
            </div>
          </div>
        </div>

        <div class="info-box">
          <strong>How it works?</strong><br />
          Messages are stored in DB and also pushed into a Redis Stream
          for asynchronous processing. This UI talks only to the REST API.
        </div>
      </aside>

      <!-- MAIN CHAT AREA -->
      <main class="main">
        <div class="top-bar">
          <div class="top-info">
            <h1>General Chat</h1>
            <span>Say hi to your teammates and test the live chat API.</span>
          </div>
          <span class="badge">Live Chat Â· v1</span>
        </div>

        <!-- JOIN CARD -->
        <section id="joinCard" class="join-card">
          <div class="join-title">Login or Register</div>
          <div class="join-sub">
            Choose a username and password. You can login with an existing account or
            create a new one. After that, you can start chatting in the
            <strong>#general</strong> room.
          </div>

          <form id="joinForm" class="join-form" onsubmit="return false;">
            <!-- Username -->
            <input
              id="usernameInput"
              class="input"
              type="text"
              placeholder="Username (e.g., enes)"
              autocomplete="off"
              required
            />

            <!-- Password -->
            <input
              id="passwordInput"
              class="input"
              type="password"
              placeholder="Password"
              autocomplete="off"
              required
              style="margin-top: 10px;"
            />

            <!-- AUTH BUTTONS -->
            <button id="loginBtn" class="btn btn-primary" type="button">
              Login
            </button>

            <button id="registerBtn" class="btn btn-secondary" type="button">
              Register
            </button>

            <!-- Guest -->
            <button id="skipBtn" class="btn btn-ghost" type="button">
              Continue as guest
            </button>
          </form>

          <div id="joinError" class="error-text"></div>
        </section>


        <!-- CHAT SHELL -->
        <section class="chat-shell" id="chatShell" style="display:none;">
          <div id="messages" class="messages"></div>

          <div class="composer">
            <input
              id="messageInput"
              class="composer-input"
              type="text"
              placeholder="Type a message and press Enter..."
              autocomplete="off"
            />
            <button id="sendBtn" class="btn btn-primary" type="button">
              Send
            </button>
          </div>
          <div class="composer-status" id="composerStatus">
            Fetching latest messagesâ€¦
          </div>
        </section>
      </main>
    </div>

    <script>
      (function () {
        const API_USERS = "/users";
        const API_MESSAGES = "/messages";
        const API_AUTH_REGISTER = "/auth/register";
        const API_AUTH_LOGIN = "/auth/login";


        let currentUser = null;
        let pollingInterval = null;
        let isSending = false;

        const joinCard = document.getElementById("joinCard");
        const joinForm = document.getElementById("joinForm");
        const joinBtn = document.getElementById("joinBtn");
        const skipBtn = document.getElementById("skipBtn");
        const usernameInput = document.getElementById("usernameInput");
        const joinError = document.getElementById("joinError");

        const chatShell = document.getElementById("chatShell");
        const messagesEl = document.getElementById("messages");
        const messageInput = document.getElementById("messageInput");
        const sendBtn = document.getElementById("sendBtn");
        const composerStatus = document.getElementById("composerStatus");

        const currentUserCard = document.getElementById("currentUserCard");
        const currentUserNameEl = document.getElementById("currentUserName");
        const userAvatarEl = document.getElementById("userAvatar");

        const loginBtn = document.getElementById("loginBtn");
        const registerBtn = document.getElementById("registerBtn");
        const passwordInput = document.getElementById("passwordInput");
        const logoutBtn = document.getElementById("logoutBtn");


        function initials(name) {
          return name
            .split(" ")
            .filter(Boolean)
            .map((p) => p[0].toUpperCase())
            .slice(0, 2)
            .join("");
        }

        function setCurrentUser(user) {
          currentUser = user;
          currentUserCard.style.display = "flex";
          currentUserNameEl.textContent = user.username;
          userAvatarEl.textContent = initials(user.username);
        }

        function handleLogout() {
          currentUser = null;

          currentUserCard.style.display = "none";
          chatShell.style.display = "none";
          joinCard.style.display = "flex";

          messagesEl.innerHTML = "";
          composerStatus.textContent = "You are logged out.";

          usernameInput.value = "";
          passwordInput.value = "";

          if (pollingInterval) {
            clearInterval(pollingInterval);
            pollingInterval = null;
          }
        }

        
        

        // /users listesini al
        async function fetchAllUsers() {
          const res = await fetch(API_USERS);
          if (!res.ok) {
            throw new Error("Failed to load users");
          }
          const json = await res.json();
          return Array.isArray(json)
            ? json
            : Array.isArray(json.data)
            ? json.data
            : [];
        }

        async function registerUser(username, password) {
          const res = await fetch(API_AUTH_REGISTER, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ username, password }),
          });

          if (!res.ok) {
            const errText = await res.text();
            console.error("Register failed:", res.status, errText);
            throw new Error("Register failed");
          }

          const json = await res.json();
          return json.data ? json.data : json;
        }

        async function loginUser(username, password) {
          const res = await fetch(API_AUTH_LOGIN, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ username, password }),
          });

          if (!res.ok) {
            const errText = await res.text();
            console.error("Login failed:", res.status, errText);
            throw new Error("Login failed");
          }

          const json = await res.json();
          return json.data ? json.data : json;
        }


        function toggleLoadingJoin(isLoading) {
          loginBtn.disabled = isLoading;
          registerBtn.disabled = isLoading;
          skipBtn.disabled = isLoading;
          loginBtn.textContent = isLoading ? "Please wait..." : "Login";
        }


        async function handleAuth(action) {
          const username = usernameInput.value.trim();
          const password = passwordInput.value.trim();
          joinError.textContent = "";

          if (!username || !password) {
            joinError.textContent = "Username ve password gerekli.";
            return;
          }

          try {
            toggleLoadingJoin(true);

            let user;
            if (action === "login") {
              user = await loginUser(username, password);
            } else {
              user = await registerUser(username, password);
            }

            setCurrentUser(user);

            // ðŸ”¹ BURASI Ã–NEMLÄ°: tÃ¼m kullanÄ±cÄ±larÄ± Ã§ek ve cache'e koy
            try {
              window._allUsersCache = await fetchAllUsers();
            } catch (e) {
              console.warn("fetchAllUsers failed:", e);
            }

            joinCard.style.display = "none";
            chatShell.style.display = "flex";
            startPolling();
            messageInput.focus();
          } catch (err) {
            // ...
          } finally {
            toggleLoadingJoin(false);
          }
        }


        loginBtn.addEventListener("click", () => handleAuth("login"));
        registerBtn.addEventListener("click", () => handleAuth("register"));


        // Guest 
        skipBtn.addEventListener("click", async () => {
          joinError.textContent = "";
          const guestName = "Guest-" + Math.floor(Math.random() * 9000 + 1000);

          try {
            toggleLoadingJoin(true);
            const user = await createUser(guestName);
            setCurrentUser(user);
            window._allUsersCache = await fetchAllUsers();
            try {
              window._allUsersCache = await fetchAllUsers();
            } catch {}
            joinCard.style.display = "none";
            chatShell.style.display = "flex";
            startPolling();
            messageInput.focus();
          } catch (err) {
            console.error(err);
            joinError.textContent =
              "Guest user could not be created. Please try again.";
          } finally {
            toggleLoadingJoin(false);
          }
        });

        async function fetchMessages() {
          try {
            const res = await fetch(API_MESSAGES);
            if (!res.ok) throw new Error("Failed to load messages");
            let data = await res.json();

            const messages = Array.isArray(data)
              ? data
              : Array.isArray(data.data)
              ? data.data
              : [];

            renderMessages(messages);
            composerStatus.textContent =
              "Connected Â· Last update: " + new Date().toLocaleTimeString();
          } catch (err) {
            console.error(err);
            composerStatus.textContent =
              "Could not fetch messages. Check server / API.";
          }
        }

        function renderMessages(messages) {
          const distanceFromBottomBefore =
            messagesEl.scrollHeight - messagesEl.scrollTop - messagesEl.clientHeight;
          const wasNearBottom = distanceFromBottomBefore < 40; // 40px tolerans

          let userMap = {};
          if (window._allUsersCache) {
            window._allUsersCache.forEach((u) => {
              userMap[u.id] = u.username;
            });
          }

          const prevDistanceFromBottom =
            messagesEl.scrollHeight - messagesEl.scrollTop;

          messagesEl.innerHTML = "";
          messages.forEach((m) => {
            const username =
              userMap[m.userId] ||
              m.user?.username ||
              (m.userId ? "User " + m.userId : "Anon");

            const isSelf =
              currentUser &&
              currentUser.username &&
              username.toLowerCase() === currentUser.username.toLowerCase();

            const row = document.createElement("div");
            row.className = "msg-row" + (isSelf ? " self" : "");

            const avatar = document.createElement("div");
            avatar.className = "msg-avatar";
            avatar.textContent = initials(username);

            const bubble = document.createElement("div");
            bubble.className = "msg-bubble";

            const meta = document.createElement("div");
            meta.className = "msg-meta";
            const authorSpan = document.createElement("span");
            authorSpan.className = "msg-author";
            authorSpan.textContent = username;
            meta.appendChild(authorSpan);

            const content = document.createElement("div");
            content.textContent = m.content || m.text || "";

            const time = document.createElement("div");
            time.className = "msg-time";
            const date = m.createdAt ? new Date(m.createdAt) : new Date();
            time.textContent = date.toLocaleTimeString();

            bubble.appendChild(meta);
            bubble.appendChild(content);
            bubble.appendChild(time);

            row.appendChild(avatar);
            row.appendChild(bubble);

            messagesEl.appendChild(row);
          });

          if (wasNearBottom) {
            messagesEl.scrollTop = messagesEl.scrollHeight;
          } else {
            messagesEl.scrollTop = messagesEl.scrollHeight - prevDistanceFromBottom;
          }
        }


        async function sendMessage() {
          if (!currentUser || !currentUser.id) {
            alert("Please join the chat first.");
            return;
          }
          const text = messageInput.value.trim();
          if (!text || isSending) return;

          isSending = true;
          sendBtn.disabled = true;

          try {
            const body = {
              userId: currentUser.id,
              content: text,
            };

            const res = await fetch(API_MESSAGES, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(body),
            });

            if (!res.ok) {
              let t = await res.text();
              console.error("Send message failed:", res.status, t);
              throw new Error("Failed to send message");
            }

            messageInput.value = "";
            fetchMessages();
          } catch (err) {
            console.error(err);
            alert("Could not send message. Please try again.");
          } finally {
            isSending = false;
            sendBtn.disabled = false;
          }
        }

        function startPolling() {
          fetchMessages();
          if (pollingInterval) clearInterval(pollingInterval);
          pollingInterval = setInterval(fetchMessages, 2000);
        }

        sendBtn.addEventListener("click", sendMessage);
        messageInput.addEventListener("keydown", (e) => {
          if (e.key === "Enter" && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
          }
        });
        logoutBtn.addEventListener("click", handleLogout);

        // Ä°lk yÃ¼kleme
        fetchMessages();
      })();
    </script>
  </body>
</html>
